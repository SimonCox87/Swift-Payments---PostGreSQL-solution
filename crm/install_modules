#!/bin/bash

# Function to install Node.js and npm if not installed
install_node() {
    echo "Checking Node.js and npm installation..."
    if ! command -v node &> /dev/null || ! command -v npm &> /dev/null; then
        echo "Node.js or npm is not installed. Attempting to install..."
        
        if [[ "$OSTYPE" == "darwin"* ]]; then
            if ! command -v brew &> /dev/null; then
                echo "Homebrew is not installed. Installing Homebrew..."
                /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                echo "Homebrew installation complete."
            fi
            brew install node
        elif [[ -f "/etc/debian_version" ]]; then
            sudo apt update
            sudo apt install -y nodejs npm
        elif [[ -f "/etc/redhat-release" ]]; then
            sudo yum install -y nodejs npm
        else
            echo "Unsupported OS. Please install Node.js manually."
            exit 1
        fi

        echo "Node.js and npm installation complete."
    else
        echo "Node.js and npm are already installed."
    fi
}

# Check and install Node.js and npm
install_node

# Function to install dependencies and handle frontend-specific issues
setup_project() {
    local dir=$1
    local name=$2

    echo "Setting up $name in $dir..."

    cd "$dir" || exit

    if [ -f "package.json" ]; then
        echo "Installing dependencies for $name..."
        
        # Remove package-lock.json if it exists (fix for ajv dependency issue)
        if [ -f "package-lock.json" ]; then
            echo "Removing package-lock.json to avoid version conflicts..."
            rm -f package-lock.json
        fi
        
        npm install
        if [ ! -d "node_modules" ]; then
            echo "Error: Dependencies not installed correctly in $dir."
            exit 1
        fi
    else
        echo "package.json not found in $dir. Please ensure it exists."
        exit 1
    fi
}

# Backend setup
setup_project "./server" "Backend"

# Frontend setup
setup_project "../client" "Frontend"

# PostgreSQL setup
install_postgresql() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "Installing PostgreSQL on macOS..."
        if ! command -v brew &> /dev/null; then
            echo "Homebrew is not installed. Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        brew install postgresql
        brew services start postgresql
    elif [[ -f "/etc/debian_version" ]]; then
        echo "Installing PostgreSQL on Debian/Ubuntu..."
        sudo apt update
        sudo apt install -y postgresql postgresql-contrib
        sudo systemctl start postgresql
        sudo systemctl enable postgresql
    elif [[ -f "/etc/redhat-release" ]]; then
        echo "Installing PostgreSQL on Red Hat/CentOS..."
        sudo yum install -y postgresql-server postgresql-contrib
        sudo postgresql-setup initdb
        sudo systemctl start postgresql
        sudo systemctl enable postgresql
    else
        echo "Unsupported OS for automatic PostgreSQL installation."
        exit 1
    fi
}

if ! command -v psql &> /dev/null; then
    install_postgresql
else
    echo "PostgreSQL is already installed."
fi

# Grant permissions and configure PostgreSQL
update_permissions() {
    local path=$1
    echo "Updating permissions for $path..."
    if [[ "$OSTYPE" == "darwin"* || "$OSTYPE" == "linux-gnu"* ]]; then
        sudo setfacl -m u:postgres:rx "$path"
    else
        echo "Unsupported OS for updating permissions. Please grant permissions manually."
    fi
}

# Ensure postgres can access all directories in the path to init.sql
SCRIPT_DIR="$(pwd)"
IFS='/' read -ra DIRS <<< "$SCRIPT_DIR"
CURRENT_PATH=""
for DIR in "${DIRS[@]}"; do
    CURRENT_PATH="$CURRENT_PATH/$DIR"
    update_permissions "$CURRENT_PATH"
done

# Configure PostgreSQL
echo "Configuring PostgreSQL..."
INIT_SQL_PATH="$SCRIPT_DIR/init.sql"

if [ ! -f "$INIT_SQL_PATH" ]; then
    echo "Error: init.sql not found at $INIT_SQL_PATH."
    exit 1
fi

sudo chmod 644 "$INIT_SQL_PATH"
sudo chown postgres:postgres "$INIT_SQL_PATH"

sudo -u postgres psql <<EOF
ALTER USER postgres PASSWORD 'postgres';
CREATE DATABASE crm;
\c crm
\i '$INIT_SQL_PATH'
EOF

echo "PostgreSQL setup complete. Database 'crm' created with data from init.sql."

# Instructions to start frontend and backend servers
echo "Setup is complete. You can now start your servers."

echo -n "Would you like to start the backend server now? (Y to start): "
read start_backend
if [ "$start_backend" == "Y" ]; then
    echo "Starting backend server..."
    cd ./server || exit
    npm start
else
    echo "Skipping backend server start. You can start it manually later."
fi

echo -n "Would you like to start the frontend server now? (Y to start): "
read start_frontend
if [ "$start_frontend" == "Y" ]; then
    echo "Starting frontend server..."
    cd ../client || exit
    npm start
else
    echo "Skipping frontend server start. You can start it manually later."
fi
